# 卡密到期管理和时间累加功能

## 功能说明

### 功能1: 卡密到期不可登录

- **触发条件**: 用户登录时检查卡密是否过期
- **影响范围**: 普通用户（user角色），管理员和站长不受限制
- **过期提示**: "卡密已过期，请在设置页面重新绑定新卡密"
- **处理方式**: 用户需要进入"设置"页面，在"卡密管理"区域绑定新卡密

### 功能2: 绑定新卡密时累加到期时间

- **触发条件**: 用户在设置页面绑定新卡密
- **计算逻辑**:
  - 如果用户当前没有卡密：使用新卡密的过期时间
  - 如果用户当前有卡密且未过期：从当前过期时间开始累加新卡密的有效期
  - 如果用户当前有卡密但已过期：从现在开始累加新卡密的有效期

**示例**:

```
场景1: 用户首次绑定卡密
- 当前状态: 无卡密
- 绑定周卡（7天）
- 结果: 过期时间 = 创建时间 + 7天

场景2: 用户续费（卡密未过期）
- 当前状态: 卡密剩余30天过期
- 绑定月卡（30天）
- 结果: 过期时间 = 当前过期时间 + 30天 = 剩余60天

场景3: 用户过期后续费
- 当前状态: 卡密已过期10天
- 绑定季卡（90天）
- 结果: 过期时间 = 当前时间 + 90天
```

---

## 技术实现

### 卡密过期检查（登录时）

**文件**: `src/app/api/login/route.ts`

```typescript
// 检查卡密是否过期（管理员除外）
const userRole = user?.role || 'user';
if (userRole !== 'owner' && userRole !== 'admin') {
  const isExpired = await cardKeyService.isUserCardKeyExpired(username);
  if (isExpired) {
    return NextResponse.json(
      { error: '卡密已过期，请在设置页面重新绑定新卡密' },
      { status: 401 },
    );
  }
}
```

**检查逻辑**:

1. 获取用户卡密信息
2. 比较 `expiresAt` 和当前时间
3. 如果 `expiresAt < 当前时间`，则认为卡密已过期

### 时间累加逻辑（绑定时）

**文件**: `src/lib/cardkey.ts`

```typescript
// 计算新的过期时间
let newExpiresAt = validation.cardKey.expiresAt;
let isNewCardKey = !currentCardKeyInfo;

if (currentCardKeyInfo) {
  // 用户已有卡密，计算新卡密的额外天数
  const currentExpiryDate = currentCardKeyInfo.expiresAt;
  const newCardKeyExpiryDate = validation.cardKey.expiresAt;
  const newCardKeyCreatedAt = validation.cardKey.createdAt;

  // 计算新卡密的有效期（天数）
  const newCardKeyDuration = Math.round(
    (newCardKeyExpiryDate - newCardKeyCreatedAt) / (1000 * 60 * 60 * 24),
  );

  // 如果当前卡密已过期，从现在开始累加；否则从当前过期时间开始累加
  const baseTime =
    currentExpiryDate < Date.now() ? Date.now() : currentExpiryDate;
  newExpiresAt = baseTime + newCardKeyDuration * 24 * 60 * 60 * 1000;
}
```

**计算步骤**:

1. 获取用户当前卡密信息
2. 计算新卡密的有效期（天数）= (新卡密过期时间 - 新卡密创建时间) / (24小时）
3. 确定累加基数:
   - 如果当前卡密已过期：使用当前时间作为基数
   - 如果当前卡密未过期：使用当前卡密的过期时间作为基数
4. 计算新的过期时间 = 基数 + 新卡密有效期的毫秒数

---

## 测试场景

### 测试1: 卡密过期无法登录

1. 创建测试卡密（例如：周卡）
2. 使用卡密注册用户
3. 等待卡密过期（或手动修改数据库让卡密过期）
4. 尝试登录
5. 预期结果: 登录失败，提示"卡密已过期，请在设置页面重新绑定新卡密"

### 测试2: 绑定新卡密累加时间（未过期）

1. 创建测试用户，绑定月卡（30天）
2. 等待10天（剩余20天）
3. 创建新卡密（周卡，7天）
4. 绑定新卡密
5. 预期结果: 过期时间 = 原过期时间 + 7天 = 剩余27天

### 测试3: 绑定新卡密累加时间（已过期）

1. 创建测试用户，绑定月卡（30天）
2. 等待卡密过期（或手动修改数据库让卡密过期）
3. 创建新卡密（季卡，90天）
4. 绑定新卡密
5. 预期结果: 过期时间 = 当前时间 + 90天

### 测试4: 首次绑定卡密

1. 创建测试用户
2. 创建测试卡密（月卡，30天）
3. 绑定卡密
4. 预期结果: 过期时间 = 当前时间 + 30天

---

## 用户界面

### 登录时过期提示

```
错误信息: 卡密已过期，请在设置页面重新绑定新卡密
状态码: 401
```

### 卡密绑定界面

```
标题: 卡密管理

已绑定卡密区域:
- 卡密: [明文卡密] [复制按钮]
- 过期时间: 2026-03-15 12:00:00
- 剩余天数: 30 天
- 状态: 正常

重新绑定区域:
说明文字: 绑定新卡密可以延长您的账户有效期。
           新卡密的有效期将累加到当前过期时间。
输入框: [请输入新卡密]
按钮: [绑定新卡密]
```

---

## 管理员后台

### 卡密管理列表

```
卡密         | 类型 | 状态 | 创建时间 | 过期时间 | 绑定用户 | 操作
-------------|------|------|----------|----------|----------|------
AbCdEf123... | 月卡 | 已使用 | xxx      | xxx      | user1    | [删除]
GhIjKl456... | 周卡 | 未使用 | xxx      | xxx      | -         | [删除]
```

**状态说明**:

- 未使用: 可以删除
- 已使用: 不能删除，但可以查看绑定用户
- 已过期: 自动标记，不能删除

---

## 调试日志

### 绑定卡密时的日志

```
绑定卡密 - 用户已有卡密，累加时间: 30天，新过期时间: 2026-03-15 12:00:00
绑定卡密 - 用户新绑定，过期时间: 2026-02-14 12:00:00
更新卡密状态为已使用，keyHash: xxx
更新卡密状态: xxx unused -> used
更新用户卡密信息，username: user1
updateUserCardKeyInfo - userName: user1 info: { ... }
updateUserCardKeyInfo - userIndex: 1 total users: 2
```

---

## 注意事项

### 时间计算

- 新卡密的有效期 = 新卡密过期时间 - 新卡密创建时间
- 累加基数 = max(当前卡密过期时间, 当前时间)
- 新过期时间 = 累加基数 + 新卡密有效期

### 角色权限

- owner: 站长，不需要卡密
- admin: 管理员，不需要卡密
- user: 普通用户，需要卡密

### 卡密状态

- unused: 未使用，可以删除
- used: 已使用，不能删除
- expired: 已过期，不能删除

---

## 后续优化建议

1. **到期提醒**
   - 在卡密即将过期前7天、3天、1天发送提醒
   - 通过邮件、站内消息或推送通知

2. **自动续费**
   - 支持自动续费功能
   - 绑定支付方式，到期前自动续费

3. **卡密套餐**
   - 创建卡密套餐（如：月度套餐、季度套餐、年度套餐）
   - 套餐优惠（如：季度套餐比单独买3个月便宜）

4. **卡密转让**
   - 允许用户将剩余时间转让给其他用户
   - 转让需要双方确认

5. **使用统计**
   - 记录卡密使用日志
   - 统计用户活跃度
   - 分析卡密使用情况

---

**更新人**: AI Coding Agent
**更新日期**: 2026-02-14
**版本**: v3.0
**状态**: ✓ 已完成
