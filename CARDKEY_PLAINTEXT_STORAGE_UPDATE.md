# 卡密明文存储功能更新

## 更新日期

2026-02-14

## 更新说明

本次更新将卡密系统从"仅存储哈希"改为"同时存储明文和哈希"，允许管理员随时查看和复制已创建的卡密。

---

## 变更内容

### 1. 数据结构变更

#### 之前（仅存储哈希）

```typescript
interface CardKey {
  key: string; // 哈希值
  keyType: CardKeyType;
  status: CardKeyStatus;
  createdAt: number;
  expiresAt: number;
  boundTo?: string;
  boundAt?: number;
}
```

#### 现在（同时存储明文和哈希）

```typescript
interface CardKey {
  key: string; // 明文卡密
  keyHash: string; // 哈希值（用于验证）
  keyType: CardKeyType;
  status: CardKeyStatus;
  createdAt: number;
  expiresAt: number;
  boundTo?: string;
  boundAt?: number;
}
```

### 2. 卡密创建逻辑变更

#### 之前

- 生成明文卡密
- 计算哈希值
- 存储哈希值到数据库
- 返回明文卡密给管理员

#### 现在

- 生成明文卡密
- 计算哈希值
- 同时存储明文和哈希到数据库
- 返回明文卡密给管理员

### 3. 卡密验证逻辑变更

#### 之前

```typescript
const storedCardKey = await db.getCardKey(hashedKey);
```

#### 现在

```typescript
const allCardKeys = await db.getAllCardKeys();
const storedCardKey = allCardKeys.find((ck) => ck.keyHash === hashedKey);
```

**注意**: 由于需要匹配 keyHash，现在需要获取所有卡密并查找匹配项。这可能会影响性能，如果卡密数量很大，建议添加索引。

### 4. UI变更

#### 之前

- 卡密列表显示哈希值前20个字符
- 提示"明文卡密仅在创建时显示一次"

#### 现在

- 卡密列表显示完整明文卡密
- 每个卡密旁边有复制按钮
- 提示"这些卡密已保存到数据库，您可以随时在卡密列表中查看和复制"

---

## 修改的文件

| 文件                                | 修改内容                                                    |
| ----------------------------------- | ----------------------------------------------------------- |
| `src/lib/types.ts`                  | 添加 `keyHash` 字段到 CardKey 接口                          |
| `src/lib/cardkey.ts`                | 更新 createCardKey、validateCardKey、bindCardKeyToUser 方法 |
| `src/lib/redis-base.db.ts`          | 更新 createCardKey 方法，使用 keyHash 作为键                |
| `src/lib/upstash.db.ts`             | 更新 createCardKey 方法，使用 keyHash 作为键                |
| `src/components/CardKeyManager.tsx` | 更新UI，显示明文卡密并添加复制按钮                          |

---

## 安全考虑

### 优点

1. **管理便利性**: 管理员可以随时查看和复制卡密
2. **容错性**: 即使忘记保存，也可以在列表中找到卡密
3. **用户体验**: 减少了管理员的操作步骤

### 风险

1. **数据库安全**: 如果数据库被泄露，攻击者可以直接获取明文卡密
2. **访问控制**: 需要严格限制管理员权限

### 缓解措施

1. **数据库加密**: 建议对卡密字段进行加密存储
2. **访问日志**: 记录所有查看卡密的操作
3. **权限控制**: 只有 owner 和 admin 角色可以访问卡密
4. **网络安全**: 确保数据库访问受到限制

---

## 数据迁移

### 现有数据

现有的卡密只有哈希值，没有明文。这些卡密仍然可以正常使用，但无法在列表中显示明文。

### 新数据

新创建的卡密会同时包含明文和哈希。

### 迁移方案（可选）

如果需要为现有卡密找回明文，有以下选项：

#### 选项1: 重新生成卡密

- 删除现有未使用的卡密
- 重新创建相同数量的卡密

#### 选项2: 维持现状

- 现有卡密继续使用
- 新卡密使用新的存储方式

---

## 使用说明

### 查看卡密列表

1. 登录管理员账户
2. 进入管理面板
3. 点击"卡密管理"
4. 查看所有卡密列表

### 复制单条卡密

1. 在卡密列表中找到需要复制的卡密
2. 点击卡密右侧的复制图标
3. 卡密已复制到剪贴板

### 复制全部卡密

1. 创建新卡密后，在弹窗中点击"复制全部卡密"
2. 所有卡密复制到剪贴板，每个一行

---

## 性能影响

### validateCardKey 方法

**之前**: 直接通过哈希值查找，O(1)
**现在**: 获取所有卡密后查找，O(n)

**优化建议**:

1. 如果卡密数量超过1000，建议添加 keyHash 索引
2. 可以使用 Redis 的 HSET 存储卡密，keyHash 作为 field

### 内存占用

**之前**: 每个卡密约 64 字节（SHA-256 哈希）
**现在**: 每个卡密约 80 字节（16字节明文 + 64字节哈希）

内存增加约 25%，但对于大多数应用来说影响很小。

---

## 测试建议

### 功能测试

1. ✓ 创建新卡密，验证明文和哈希都保存成功
2. ✓ 在列表中查看卡密，确认显示明文
3. ✓ 点击复制按钮，确认复制成功
4. ✓ 使用新卡密注册用户，验证验证逻辑正常
5. ✓ 验证旧卡密（只有哈希的）仍然可以正常使用

### 安全测试

1. ✓ 验证非管理员无法访问卡密列表
2. ✓ 验证普通用户无法查看卡密明文
3. ✓ 测试数据库访问权限

### 性能测试

1. ✓ 测试创建1000个卡密的性能
2. ✓ 测试验证卡密的性能
3. ✓ 测试获取卡密列表的性能

---

## 后续优化建议

1. **添加搜索功能**
   - 按卡密明文搜索
   - 按状态筛选
   - 按类型筛选

2. **添加导出功能**
   - 导出为 CSV
   - 导出为 JSON
   - 自定义格式

3. **添加历史记录**
   - 记录卡密查看历史
   - 记录卡密复制历史
   - 审计日志

4. **性能优化**
   - 添加 keyHash 索引
   - 使用 Redis HSET 存储卡密
   - 分页加载卡密列表

---

## 回滚方案

如果需要回滚到之前的实现，请按以下步骤操作：

1. 恢复 `src/lib/types.ts` 中的 CardKey 接口定义
2. 恢复 `src/lib/cardkey.ts` 中的验证逻辑
3. 恢复数据库操作方法
4. 恢复 UI 显示逻辑

**注意**: 回滚后，新创建的卡密将无法在列表中查看明文，但已有卡密仍然可以正常使用。

---

**更新人**: AI Coding Agent
**更新日期**: 2026-02-14
**版本**: v2.0
**风险评估**: 中等（数据库安全）
