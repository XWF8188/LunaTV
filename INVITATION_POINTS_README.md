# 积分兑换和邀请奖励系统使用说明

## 功能概述

本系统实现了以下功能：

1. **邀请码生成**：每个用户注册后自动获得一个邀请码（用户名即为邀请码）
2. **邀请注册**：新用户可以通过邀请码注册，建立推荐关系
3. **积分奖励**：邀请人可获得积分奖励（默认100积分/人）
4. **积分兑换**：用户可以使用积分兑换一周卡密（默认300积分/张）
5. **IP防作弊**：同一IP地址只能奖励一次
6. **我的邀请页面**：查看邀请统计、复制邀请链接
7. **积分兑换页面**：查看积分余额、兑换卡密、查看积分历史

## 使用方法

### 1. 管理员配置邀请规则

管理员需要在数据库中设置邀请配置：

```javascript
// 在Redis中设置配置
await db.storage.setInvitationConfig({
  enabled: true, // 是否启用邀请奖励系统
  rewardPoints: 100, // 邀请一人获得的积分
  redeemThreshold: 300, // 兑换一周卡密所需积分
  cardKeyType: 'week', // 兑换的卡密类型
  updatedAt: Date.now(),
});
```

### 2. 用户邀请流程

1. 用户登录后，点击"我的邀请"菜单
2. 复制邀请链接分享给好友
3. 好友通过链接注册（会自动填充邀请码）
4. 邀请人获得积分奖励

### 3. 积分兑换流程

1. 用户登录后，点击"积分兑换"菜单
2. 查看当前积分余额
3. 如果积分足够（300积分），点击"兑换一周卡密"
4. 获得卡密后，可以在"我的卡密"页面查看

### 4. 查看积分历史

在积分兑换页面可以查看所有积分的获取和消费记录，包括：

- 获取时间
- 获取/消费类型
- 积分数量
- 原因说明

## 注意事项

1. **存储类型要求**：本功能需要使用Redis、Upstash或Kvrocks作为存储类型，不支持localStorage
2. **邀请码规则**：当前实现中，用户名即为邀请码（简化实现）
3. **IP防作弊**：同一IP地址只能奖励一次，防止通过同一设备多次注册获取积分
4. **积分兑换**：兑换操作是原子的，要么全部成功，要么全部失败

## API接口

### 公开接口

- `GET /api/invitation/info` - 获取用户邀请信息
- `GET /api/points/balance` - 获取积分余额
- `GET /api/points/history` - 获取积分历史
- `POST /api/redeem/cardkey` - 兑换卡密
- `GET /api/cardkeys/my` - 获取用户卡密列表

### 管理员接口

- `GET /api/admin/invitation-config` - 获取邀请配置
- `PUT /api/admin/invitation-config` - 更新邀请配置

### 注册接口（已扩展）

- `POST /api/register` - 支持邀请码参数

## 前端页面

- `/my-invitation` - 我的邀请页面
- `/points-exchange` - 积分兑换页面

## 用户菜单新增入口

在用户菜单中添加了以下菜单项：

- "我的邀请" - 查看邀请信息和统计
- "积分兑换" - 查看积分和兑换卡密
- "我的卡密" - 查看已拥有的卡密（已存在，新增了来源显示）

## 技术架构

- **数据库层**：Redis/Upstash/Kvrocks存储积分、邀请关系、IP记录等
- **服务层**：InvitationService（邀请服务）、PointsService（积分服务）
- **API层**：提供RESTful API接口
- **前端层**：React组件实现用户界面

## 安全性

1. **IP防作弊**：防止同一设备多次注册获取积分
2. **积分验证**：兑换前验证积分是否足够
3. **事务原子性**：积分变更和卡密生成在同一事务中
4. **并发控制**：防止并发请求导致的积分超支

## 未来改进

1. 实现真正的随机邀请码（而非用户名）
2. 添加管理后台配置界面
3. 支持多种卡密类型兑换
4. 添加邀请排行榜
5. 支持积分转账功能
