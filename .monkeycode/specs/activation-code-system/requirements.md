# 需求文档：卡密激活系统

## 简介

本文档定义了 LunaTV Enhanced Edition 的卡密激活系统需求，用于控制用户注册和账号有效期管理。该系统通过卡密机制实现新用户注册控制和付费管理功能。

## 术语表

- **卡密（Activation Code）**：用于用户注册和账号续期的一次性激活码
- **激活有效期**：卡密激活后用户账号的有效期限，默认为 1 年
- **到期日（Expiration Date）**：用户账号失效的日期
- **普通用户（Regular User）**：通过卡密注册的用户，受有效期限制
- **管理员用户（Admin User）**：具有管理权限的用户，不受卡密和有效期限制
- **续期（Renewal）**：使用新卡密延长账号有效期的操作

## 需求

### 需求 1：卡密注册控制

**用户故事**：作为网站管理员，我希望新用户必须输入卡密才能注册，以便控制用户数量并实现付费管理。

#### 验收标准

1. WHEN 新用户提交注册请求，系统 SHALL 验证请求中包含有效的卡密
2. IF 卡密不存在或已被使用，系统 SHALL 返回"无效的卡密"错误
3. WHEN 卡密验证成功，系统 SHALL 创建用户账号并将该卡密标记为已使用
4. WHEN 用户账号创建成功，系统 SHALL 记录用户的有效期为当前日期加 1 年
5. IF 注册时未提供卡密或卡密格式错误，系统 SHALL 拒绝注册并返回错误信息

### 需求 2：卡密一次性使用

**用户故事**：作为网站管理员，我希望每个卡密只能使用一次，防止卡密被重复使用。

#### 验收标准

1. WHEN 卡密被成功用于注册，系统 SHALL 立即将该卡密状态标记为"已使用"
2. IF 系统收到使用已使用卡密的请求，系统 SHALL 拒绝操作并返回"该卡密已被使用"错误
3. WHEN 查询卡密状态，系统 SHALL 返回卡密的使用状态（未使用/已使用）和使用时间戳

### 需求 3：用户账号有效期

**用户故事**：作为网站管理员，我希望用户账号有 1 年的有效期，到期后自动失效。

#### 验收标准

1. WHEN 新用户通过卡密成功注册，系统 SHALL 设置账号有效期为注册日期加 365 天
2. WHEN 用户登录，系统 SHALL 检查当前日期是否在账号有效期内
3. IF 当前日期超过账号有效期，系统 SHALL 拒绝登录并返回"账号已过期"错误
4. WHEN 用户账号过期，系统 SHALL 禁止用户访问所有需要认证的 API 端点
5. IF 用户在有效期内登录，系统 SHALL 允许访问并返回用户信息

### 需求 4：到期前提醒

**用户故事**：作为普通用户，我希望在账号到期前 30 天收到提醒，以便及时续期。

#### 验收标准

1. WHEN 用户成功登录，系统 SHALL 计算剩余有效天数
2. IF 剩余有效天数小于等于 30 天，系统 SHALL 在响应中包含"到期前提醒"标记和剩余天数
3. WHEN 前端收到到期前提醒标记，系统 SHALL 显示友好的续期提示信息
4. IF 剩余有效天数大于 30 天，系统 SHALL 不包含到期前提醒标记

### 需求 5：账号续期

**用户故事**：作为普通用户，我希望可以使用新的卡密来延长账号有效期。

#### 验收标准

1. WHEN 用户提交续期请求并提供有效卡密，系统 SHALL 验证卡密的有效性和状态
2. IF 卡密有效且未被使用，系统 SHALL 将账号有效期延长至当前到期日加 365 天
3. WHEN 续期成功，系统 SHALL 将使用的卡密标记为已使用
4. IF 卡密无效或已被使用，系统 SHALL 拒绝续期并返回错误信息
5. WHEN 续期完成后，系统 SHALL 返回新的账号到期日

### 需求 6：管理员不受限制

**用户故事**：作为网站管理员，我希望管理员账号不受卡密和有效期限制，以便始终能够管理系统。

#### 验收标准

1. WHEN 用户角色为"owner"或"admin"，系统 SHALL 跳过卡密验证和有效期检查
2. IF 管理员登录，系统 SHALL 允许访问所有功能
3. WHEN 管理员执行用户管理操作，系统 SHALL 不受管理员自身有效期限制
4. IF 普通用户被提升为管理员，系统 SHALL 移除该用户的有效期限制

### 需求 7：批量生成卡密

**用户故事**：作为网站管理员，我希望可以在后台批量生成卡密，以便分发给用户。

#### 验收标准

1. WHEN 管理员提交批量生成卡密请求，系统 SHALL 验证请求者具有管理员权限
2. IF 请求者权限不足，系统 SHALL 返回"权限不足"错误
3. WHEN 生成卡密数量有效（1-1000），系统 SHALL 生成指定数量的唯一卡密
4. WHEN 卡密生成完成，系统 SHALL 返回所有新生成的卡密列表
5. IF 生成数量超出限制（大于 1000），系统 SHALL 返回"单次生成数量不能超过 1000"错误

### 需求 8：卡密管理

**用户故事**：作为网站管理员，我希望可以查看、删除和导出卡密，以便有效管理卡密库存。

#### 验收标准

1. WHEN 管理员请求卡密列表，系统 SHALL 返回所有卡密的状态、创建时间和使用时间
2. WHEN 管理员删除未使用的卡密，系统 SHALL 从数据库中移除该卡密
3. WHEN 管理员删除已使用的卡密，系统 SHALL 仅从显示列表中移除但保留使用记录
4. WHEN 管理员请求导出卡密，系统 SHALL 生成 CSV 或 JSON 格式的文件供下载
5. IF 请求者权限不足，系统 SHALL 返回"权限不足"错误

### 需求 9：用户信息查询

**用户故事**：作为网站管理员，我希望可以查看用户的到期日和续期历史，以便了解用户状态。

#### 验收标准

1. WHEN 管理员请求用户列表，系统 SHALL 返回每个用户的用户名、角色、到期日和状态
2. WHEN 管理员请求特定用户信息，系统 SHALL 返回该用户的详细信息和续期历史
3. WHEN 管理员查询用户状态，系统 SHALL 显示"正常"、"即将过期"（剩余 30 天内）或"已过期"标记
4. IF 用户未绑定卡密（如 OIDC 用户），系统 SHALL 显示该用户为"未激活"状态

### 需求 10：配置可开关

**用户故事**：作为网站管理员，我希望可以开启或关闭卡密系统，以便在不同场景下灵活控制。

#### 验收标准

1. WHEN 管理员启用卡密系统，系统 SHALL 强制新用户注册必须提供卡密
2. WHEN 管理员禁用卡密系统，系统 SHALL 允许用户直接注册无需卡密
3. WHEN 卡密系统被禁用，系统 SHALL 保持现有用户的有效期限制不变
4. WHEN 卡密系统被重新启用，系统 SHALL 恢复对新用户的卡密要求
5. WHEN 管理员切换卡密系统状态，系统 SHALL 清除相关缓存并立即生效
