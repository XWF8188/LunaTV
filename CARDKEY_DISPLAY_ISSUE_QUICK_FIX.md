# 卡密信息不显示 - 快速诊断指南

## 快速检查清单

### 1. 确认问题现象

- [ ] 用户已绑定卡密,但页面显示"未绑定卡密"
- [ ] 用户可以正常登录系统
- [ ] 其他功能正常使用

### 2. 快速诊断 (1分钟)

在服务器上运行:

```bash
# 设置环境变量
export UPSTASH_URL=your_upstash_url
export UPSTASH_TOKEN=your_upstash_token

# 诊断指定用户
node scripts/diagnose-user-cardkey.js <username>
```

查看输出结果:

#### 情况A: 用户卡密数据完整

```
✓ 用户卡密绑定信息存在
✓ 找到对应的卡密数据
✓ 状态: 正常
```

**结论**: 数据完整,问题可能在前端或网络
**下一步**: 检查前端日志和网络请求

#### 情况B: 卡密数据丢失

```
✗ 找不到对应的卡密数据
问题: 用户的卡密绑定信息存在,但卡密数据丢失
```

**结论**: 数据不一致
**下一步**: 运行修复工具

### 3. 快速修复 (5分钟)

如果是情况B,运行修复工具:

```bash
node scripts/fix-cardkeys.js
```

工具会自动:

- 检测所有数据不一致的用户
- 创建临时卡密数据
- 生成修复报告

### 4. 验证修复

修复后:

1. **再次运行诊断工具**

   ```bash
   node scripts/diagnose-user-cardkey.js <username>
   ```

   确认数据完整

2. **让用户刷新页面**
   - 重新登录
   - 进入"卡密绑定"页面
   - 确认卡密信息显示正常

3. **查看服务器日志**
   ```bash
   tail -f logs/your-log-file.log | grep "getFullUserCardKey"
   ```
   应该看到正常的日志输出

## 常见问题

### Q1: 为什么会卡密数据丢失?

可能的原因:

- Redis 数据被误删除
- 数据迁移过程中丢失
- Redis 实例故障恢复时数据丢失

### Q2: 修复后用户需要重新绑定吗?

**不需要**。修复工具会创建临时卡密数据,用户的权限和过期时间保持不变。

但建议:

- 通知受影响的用户
- 建议用户使用正规卡密重新绑定(可选)

### Q3: 修复工具会影响其他用户吗?

**不会**。修复工具只会修复数据不一致的用户,不会影响其他正常用户。

### Q4: 如果修复后还是不显示怎么办?

1. 检查前端日志:
   - 打开浏览器开发者工具 (F12)
   - 查看 Console 标签页
   - 查看是否有错误信息

2. 检查网络请求:
   - 打开开发者工具的 Network 标签页
   - 刷新页面
   - 查看 `/api/user/cardkey` 请求
   - 检查响应内容

3. 检查服务器日志:

   ```bash
   tail -f logs/your-log-file.log
   ```

   查看是否有错误信息

4. 联系技术支持,提供以下信息:
   - 用户名
   - 前端错误信息
   - 服务器日志
   - 诊断工具输出

## 预防措施

1. **定期备份数据**
   - 使用 Upstash 的自动备份功能
   - 定期导出重要数据

2. **监控数据一致性**
   - 每周运行一次诊断工具
   - 设置监控告警

3. **代码审查**
   - 避免直接删除 Redis 数据
   - 使用提供的 API 进行操作

## 相关文档

- [完整诊断指南](./docs/cardkey-debug-guide.md)
- [修复总结](./docs/cardkey-fix-summary.md)
- [卡密功能文档](./CARDKEY_QUICK_REFERENCE.md)

## 技术支持

如果以上步骤无法解决问题,请联系技术支持并提供:

1. 问题现象描述
2. 诊断工具输出
3. 服务器日志片段
4. 前端错误截图
